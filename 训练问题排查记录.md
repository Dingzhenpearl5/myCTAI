# CTAI è®­ç»ƒé—®é¢˜æ’æŸ¥è®°å½•

## æ—¥æœŸï¼š2025å¹´10æœˆ30æ—¥

---

## é—®é¢˜æ¦‚è¿°

è®­ç»ƒè¿‡ç¨‹ä¸­å‡ºç° **Dice ç³»æ•°å§‹ç»ˆä¸º 0** çš„é—®é¢˜ï¼Œå¯¼è‡´æ¨¡å‹æ— æ³•æ­£ç¡®åˆ†å‰²è‚¿ç˜¤åŒºåŸŸã€‚

```
Epoch1 Step100/387 | Loss:0.0643 | Train Dice:0.0000 | test dice 0.000000
```

**å¼‚å¸¸è¡¨ç°ï¼š**
- âœ… æŸå¤±å€¼æ­£å¸¸ä¸‹é™ (0.0643)
- âŒ è®­ç»ƒé›† Dice = 0.0000
- âŒ æµ‹è¯•é›† Dice = 0.0000

---

## é”™è¯¯åŸå› åˆ†æ

### **é”™è¯¯ 1ï¼šæ•°æ®è·¯å¾„é…ç½®é”™è¯¯** âš ï¸

**é—®é¢˜æè¿°ï¼š**
è®­ç»ƒè„šæœ¬ä¸­é…ç½®çš„æ•°æ®è·¯å¾„ä¸å­˜åœ¨

```python
# train.py ç¬¬35è¡Œ (é”™è¯¯é…ç½®)
train_dataset_path = 'C:/Users/Masoa/OneDrive/work/CTAI/src/data'  # âŒ è¯¥ç›®å½•ä¸å­˜åœ¨
```

**å®é™…æ•°æ®ç»“æ„ï¼š**
```
C:/Users/Masoa/OneDrive/work/CTAI/src/
â”œâ”€â”€ train/          âœ… è®­ç»ƒæ•°æ®å®é™…ä½ç½®
â”‚   â”œâ”€â”€ 1001/
â”‚   â”‚   â””â”€â”€ arterial phase/
â”‚   â”‚       â”œâ”€â”€ 10001.dcm
â”‚   â”‚       â”œâ”€â”€ 10001_mask.png
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ 1002/
â”‚   â””â”€â”€ ...
â””â”€â”€ test/           âœ… æµ‹è¯•æ•°æ®å®é™…ä½ç½®
    â””â”€â”€ 1001/
        â””â”€â”€ arterial phase/
```

**ä¿®å¤æ–¹æ³•ï¼š**
```python
# ä¿®æ”¹å
train_dataset_path = 'C:/Users/Masoa/OneDrive/work/CTAI/src/train'  # âœ… æ­£ç¡®è·¯å¾„
```

**å½±å“ï¼š**
- æ•°æ®åŠ è½½å¤±è´¥æˆ–åŠ è½½ç©ºæ•°æ®é›†
- å¯¼è‡´æ¨¡å‹æ— æ³•æ­£ç¡®è®­ç»ƒ

---

### **é”™è¯¯ 2ï¼štest() å‡½æ•° Dice è®¡ç®—é€»è¾‘é”™è¯¯** ğŸ”´

**é—®é¢˜æè¿°ï¼š**
æµ‹è¯•å‡½æ•°ä¸­å¯¹é¢„æµ‹ç»“æœå…ˆäºŒå€¼åŒ–åˆ° 0/1ï¼Œç„¶åé”™è¯¯åœ°ä¹˜ä»¥ 255ï¼Œå¯¼è‡´ä¸ mask èŒƒå›´ä¸ä¸€è‡´

**é”™è¯¯ä»£ç ï¼š**
```python
# train.py test() å‡½æ•° (ç¬¬133-137è¡Œ)
def test():
    # ...
    img_y = torch.squeeze(y).cpu().numpy()
    img_y[img_y >= rate] = 1          # äºŒå€¼åŒ–åˆ° 0/1
    img_y[img_y < rate] = 0
    img_y = img_y * 255                # âŒ é”™è¯¯ï¼å˜æˆ 0/255
    epoch_dice += dice_loss.dice(img_y, mask_arrary)  # âŒ èŒƒå›´ä¸åŒ¹é…
```

**é—®é¢˜åˆ†æï¼š**
- `mask_arrary` ç»è¿‡ `data_in_one()` å½’ä¸€åŒ–åèŒƒå›´æ˜¯ **[0, 1]**
- `img_y` äºŒå€¼åŒ–åæ˜¯ **[0, 1]**ï¼Œä½†ä¹˜ä»¥ 255 åå˜æˆ **[0, 255]**
- Dice è®¡ç®—æ—¶ä¸¤è€…èŒƒå›´ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç»“æœé”™è¯¯

**Dice å…¬å¼ï¼š**
```
Dice = 2 * |A âˆ© B| / (|A| + |B|)
```
å½“ A âˆˆ [0, 1] è€Œ B âˆˆ [0, 255] æ—¶ï¼Œäº¤é›†è®¡ç®—ä¼šå‡ºé”™ã€‚

**ä¿®å¤ä»£ç ï¼š**
```python
def test():
    global res, img_y, mask_arrary
    epoch_dice = 0
    with torch.no_grad():
        dataloaders = DataLoader(test_dataset, batch_size=1, shuffle=True, num_workers=0)
        for x, mask in dataloaders:
            id = x[1:]
            x = x[0].to(device)
            y = unet(x)
            mask_arrary = mask[1].cpu().squeeze(0).detach().numpy()
            img_y = torch.squeeze(y).cpu().numpy()
            
            # âœ… äºŒå€¼åŒ–é¢„æµ‹ç»“æœ (ä¿æŒ 0/1)
            img_y_binary = img_y.copy()
            img_y_binary[img_y_binary >= rate] = 1
            img_y_binary[img_y_binary < rate] = 0
            
            # âœ… ä½¿ç”¨ 0/1 èŒƒå›´è®¡ç®— Dice
            epoch_dice += dice_loss.dice(img_y_binary, mask_arrary)
            
            # å¦‚éœ€ä¿å­˜å¯è§†åŒ–ï¼Œå•ç‹¬å¤„ç†
            # img_y_save = img_y_binary * 255
        
        print('test dice %f' % (epoch_dice / len(dataloaders)))
        res['dice'].append(epoch_dice / len(dataloaders))
```

**å½±å“ï¼š**
- æµ‹è¯•é›† Dice å§‹ç»ˆä¸º 0
- æ— æ³•æ­£ç¡®è¯„ä¼°æ¨¡å‹æ€§èƒ½
- è¯¯å¯¼è®­ç»ƒè¿‡ç¨‹

---

### **é”™è¯¯ 3ï¼šè°ƒè¯•è¾“å‡ºè¿‡å¤š** ğŸ“

**é—®é¢˜æè¿°ï¼š**
è®­ç»ƒå¾ªç¯ä¸­æ¯ä¸ª batch éƒ½æ‰“å°å¼ é‡å°ºå¯¸ï¼Œå¯¼è‡´ï¼š
- ç»ˆç«¯è¾“å‡ºè¢«æ·¹æ²¡
- æ—¥å¿—ä¸å¯è¯»
- å½±å“è®­ç»ƒé€Ÿåº¦

**é”™è¯¯ä»£ç ï¼š**
```python
for x, y in dataloaders:
    x = x[0].to(device)
    y = y[1].unsqueeze(1).to(device)
    print(x.size())  # âŒ æ¯ä¸ªbatchéƒ½è¾“å‡º
    print(y.size())  # âŒ æ¯ä¸ªbatchéƒ½è¾“å‡º
```

**å½±å“ï¼š**
- è¾“å‡ºäº†ä¸Šåƒè¡Œ `torch.Size([2, 1, 512, 512])`
- éš¾ä»¥æ‰¾åˆ°å®é™…çš„è®­ç»ƒè¿›åº¦ä¿¡æ¯

**ä¿®å¤æ–¹æ³•ï¼š**
åˆ é™¤æˆ–æ³¨é‡Šæ‰è°ƒè¯•è¾“å‡º

---

## æ¬¡è¦é—®é¢˜

### **é—®é¢˜ 4ï¼šè®­ç»ƒè½®æ•°é…ç½®è¿‡é«˜**

åˆå§‹é…ç½® `epochs = 50` å¯¹äºå¿«é€ŸéªŒè¯æ¥è¯´å¤ªé•¿

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```python
# å¿«é€Ÿæµ‹è¯•é…ç½®
epochs = 2  # å¿«é€ŸéªŒè¯æ¨¡å‹æ˜¯å¦èƒ½æ­£ç¡®è®­ç»ƒ
```

éªŒè¯é€šè¿‡åå†æ”¹å› 50 æˆ–æ›´é«˜ã€‚

---

### **é—®é¢˜ 5ï¼šæ•°æ®å½’ä¸€åŒ–æ½œåœ¨é—®é¢˜**

**è§‚å¯Ÿï¼š**
`data_set/make.py` ä¸­çš„ `data_in_one()` å‡½æ•°å¯¹ mask è¿›è¡Œäº†å½’ä¸€åŒ–ï¼š

```python
def data_in_one(inputdata):
    if not inputdata.any():
        return inputdata
    inputdata = (inputdata - inputdata.min()) / (inputdata.max() - inputdata.min())
    return inputdata
```

**æ½œåœ¨å½±å“ï¼š**
- åŸå§‹ mask å¦‚æœæ˜¯ 0/255ï¼Œå½’ä¸€åŒ–åå˜æˆ 0/1 âœ… (æ­£ç¡®)
- ä½†å¦‚æœåŸå§‹ mask å·²ç»æ˜¯ 0/1ï¼Œå½’ä¸€åŒ–åä»æ˜¯ 0/1 âœ… (æ­£ç¡®)
- éœ€ç¡®ä¿æ•°æ®é›† mask æ ¼å¼ç»Ÿä¸€

---

## è§£å†³æ–¹æ¡ˆæ€»ç»“

### **å·²ä¿®å¤ï¼š**

1. âœ… **ä¿®å¤æ•°æ®è·¯å¾„**
   ```python
   train_dataset_path = 'C:/Users/Masoa/OneDrive/work/CTAI/src/train'
   ```

2. âœ… **ä¿®å¤ test() å‡½æ•° Dice è®¡ç®—**
   - ç§»é™¤ `* 255` æ“ä½œ
   - ç¡®ä¿é¢„æµ‹å’Œæ ‡ç­¾éƒ½åœ¨ [0, 1] èŒƒå›´

3. âœ… **ç§»é™¤å¤šä½™è°ƒè¯•è¾“å‡º**
   - åˆ é™¤ `print(x.size())` å’Œ `print(y.size())`

4. âœ… **ä¼˜åŒ–è®­ç»ƒé…ç½®**
   - å¿«é€Ÿæµ‹è¯•ï¼šepochs = 2
   - è¾“å‡ºé¢‘ç‡ï¼šæ¯50æ­¥

5. âœ… **å¤‡ä»½è®­ç»ƒè„šæœ¬**
   - ä¿å­˜åˆ° `train_backup.py`

---

## éªŒè¯æ­¥éª¤

### **é¢„æœŸç»“æœï¼š**

```
Epoch1 Step50/387 | Loss:0.XXXX | Train Dice:0.XXXX | test dice 0.XXXX
                                              ^^^^             ^^^^
                                           åº”è¯¥ > 0          åº”è¯¥ > 0
```

### **æˆåŠŸæŒ‡æ ‡ï¼š**
- âœ… Train Dice > 0 (è¡¨æ˜è®­ç»ƒé›†é¢„æµ‹æœ‰æ•ˆ)
- âœ… Test Dice > 0 (è¡¨æ˜æµ‹è¯•é›†è¯„ä¼°æ­£ç¡®)
- âœ… éšç€è®­ç»ƒè¿›è¡Œï¼ŒDice é€æ¸ä¸Šå‡
- ğŸ¯ æœ€ç»ˆç›®æ ‡ï¼šDice > 0.8

---

## æ–‡ä»¶ä¿®æ”¹è®°å½•

### **ä¿®æ”¹çš„æ–‡ä»¶ï¼š**

1. **train.py**
   - ç¬¬35è¡Œï¼šä¿®å¤æ•°æ®è·¯å¾„
   - ç¬¬33è¡Œï¼šepochs æ”¹ä¸º 2 (å¿«é€Ÿæµ‹è¯•)
   - ç¬¬75è¡Œï¼šè¾“å‡ºé¢‘ç‡æ”¹ä¸ºæ¯50æ­¥
   - ç¬¬120-140è¡Œï¼šä¿®å¤ test() å‡½æ•°

2. **æ–°å¢æ–‡ä»¶ï¼š**
   - `train_backup.py` - è®­ç»ƒè„šæœ¬å¤‡ä»½
   - `quick_test.py` - æ•°æ®åŠ è½½å¿«é€Ÿæµ‹è¯•è„šæœ¬
   - `debug_data.py` - æ•°æ®è°ƒè¯•è„šæœ¬

---

## ç»éªŒæ€»ç»“

### **è°ƒè¯•è¦ç‚¹ï¼š**

1. **æ•°æ®è·¯å¾„æ£€æŸ¥**
   - è®­ç»ƒå‰å…ˆéªŒè¯æ•°æ®ç›®å½•æ˜¯å¦å­˜åœ¨
   - ä½¿ç”¨ `os.path.exists()` æˆ– `Test-Path` æ£€æŸ¥

2. **æ•°å€¼èŒƒå›´ä¸€è‡´æ€§**
   - è®¡ç®—æŒ‡æ ‡å‰ç¡®ä¿é¢„æµ‹å’Œæ ‡ç­¾èŒƒå›´ä¸€è‡´
   - äºŒå€¼åŒ–ï¼š0/1 ç”¨äºè®¡ç®—
   - å¯è§†åŒ–ï¼š0/255 ç”¨äºä¿å­˜å›¾åƒ

3. **è°ƒè¯•è¾“å‡ºæ§åˆ¶**
   - é¿å…åœ¨è®­ç»ƒå¾ªç¯å†…æ‰“å°æ¯ä¸ªbatch
   - ä½¿ç”¨æ¡ä»¶è¾“å‡º (å¦‚ `if step % 100 == 0`)

4. **å¿«é€ŸéªŒè¯ç­–ç•¥**
   - å…ˆç”¨å°‘é‡ epochs éªŒè¯ä»£ç æ­£ç¡®æ€§
   - ç¡®è®¤æ— è¯¯åå†è¿›è¡Œå®Œæ•´è®­ç»ƒ

---

## é™„å½•ï¼šç›¸å…³ä»£ç ç‰‡æ®µ

### **æ­£ç¡®çš„è®­ç»ƒ Dice è®¡ç®—ï¼š**
```python
# train() å‡½æ•°ä¸­
a = outputs.cpu().detach().squeeze(1).numpy()
a[a >= rate] = 1
a[a < rate] = 0
b = y.cpu().detach().squeeze(1).numpy()
dice = dice_loss.dice(a, b)  # âœ… ä¸¤è€…éƒ½æ˜¯ 0/1
```

### **æ­£ç¡®çš„æµ‹è¯• Dice è®¡ç®—ï¼š**
```python
# test() å‡½æ•°ä¸­
img_y_binary = img_y.copy()
img_y_binary[img_y_binary >= rate] = 1
img_y_binary[img_y_binary < rate] = 0
epoch_dice += dice_loss.dice(img_y_binary, mask_arrary)  # âœ… ä¸¤è€…éƒ½æ˜¯ 0/1
```

### **æ•°æ®é›†ç»“æ„ï¼š**
```
src/train/
â”œâ”€â”€ 1001/arterial phase/*.dcm + *_mask.png
â”œâ”€â”€ 1002/arterial phase/*.dcm + *_mask.png
â””â”€â”€ ...

æ¯ä¸ªæ‚£è€…çº¦ 20 å¼  CT åˆ‡ç‰‡ + å¯¹åº”çš„ mask
æ€»è®¡ï¼š107 æ‚£è€… Ã— 20 â‰ˆ 2000+ è®­ç»ƒæ ·æœ¬
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. â³ **ç­‰å¾…å½“å‰è®­ç»ƒå®Œæˆ** - éªŒè¯ Dice > 0
2. ğŸ“Š **åˆ†æè®­ç»ƒæ›²çº¿** - æ£€æŸ¥ Loss å’Œ Dice è¶‹åŠ¿
3. ğŸ”§ **è°ƒæ•´è¶…å‚æ•°** - å¦‚éœ€è¦ï¼Œä¼˜åŒ–å­¦ä¹ ç‡ã€batch size
4. ğŸš€ **å®Œæ•´è®­ç»ƒ** - epochs æ”¹ä¸º 50+ï¼Œè®­ç»ƒå®Œæ•´æ¨¡å‹
5. ğŸ’¾ **ä¿å­˜æœ€ä½³æ¨¡å‹** - æ ¹æ®éªŒè¯é›† Dice ä¿å­˜æƒé‡

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š** 2025å¹´10æœˆ30æ—¥  
**æœ€åæ›´æ–°ï¼š** 2025å¹´10æœˆ30æ—¥  
**çŠ¶æ€ï¼š** é—®é¢˜å·²ä¿®å¤ï¼Œç­‰å¾…éªŒè¯ç»“æœ
